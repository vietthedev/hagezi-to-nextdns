// ==UserScript==
// @name            HaGeZi to NextDNS
// @namespace       vietthe.dev
// @match           https://my.nextdns.io/*
// @grant           GM_addStyle
// @version         1.1.4
// @license         MIT
// @author          vietthedev
// @compatible      firefox Violentmonkey
// @compatible      firefox Tampermonkey
// @compatible      chrome Violentmonkey
// @compatible      chrome Tampermonkey
// @compatible      opera Violentmonkey
// @compatible      opera Tampermonkey
// @compatible      safari Stay
// @compatible      edge Violentmonkey
// @compatible      edge Tampermonkey
// @compatible      brave Violentmonkey
// @compatible      brave Tampermonkey
// @description     A userscript that allows you to fetch HaGeZi lists and add them to your NextDNS allowlist and denylist.
// @description:en  A userscript that allows you to fetch HaGeZi lists and add them to your NextDNS allowlist and denylist.
// @description:vi  Userscript giúp bạn nhập các danh sách HaGeZi vào danh sách cho phép và danh sách chặn của NextDNS.
// @icon            data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAFOklEQVRogbXaXaicRxkH8N/sJmnSlOZIDC1CJRCseETFK72qFBpFvJQUpAptFdorL0pKkV540AvxQm8sokdsY6ISjNVCxSBUiSLRoq0XYpEqGGmbUGxPTmKO52N35/Fi93zsnvdrPzIw7Owzzzzz/z/zzLwz77zJzUgL0TLvsDV3oKfnigddk1LMuqvWrA2CY+6x7qzkT3hR26IfmL8ZXaWZWzwTn8ZTuENIAiEL/xQ+4+H08iy7mx2Bp+OIPb4geVI4aDNYYpD75beFx6x4zhfT9Vl0Oz2BZ2JO23E8LNyLW0rA93NyXfYLnHLI792fVqfpfnICp+Og5H7hIXxIuL0UdHH5LbyoZ9H7/NK9qTsJjAoCkTzvgGWHtOyT7ZW8U/JB4T7huDDXEOxweff/K8J5PRdkf9N2TdbBumXXLKS18Qn8KD6BE/iA7DDmMCe0xwZcDX5YRkd2VVgW/iP7M844mV5qTuCH8ajkq8JhMdAZ7qQZ6NyAyKjOqDzLuIzPeTxdqCdwOj4ieU5yZ4F3xvfwaF2ZrE6e/V1y3BPp9Z1whx9kC7FH8knhiDzwQoz8VpXr6spkVfLt/G49x42kYQLz9uOY0N5iv2l8NBeBHRd8kZ2iNj2EA8IxJ6K9E/KeEULtgWI/jRMelMfzOOFSXp9kt3qH1oBSAYEVaUs27iozC/BldrZz27uG5+0wgX2SDa3K1WMWICcB369vu1pFYFWStG7aSjJuKO2uS94zhHjXHCAGBMYBT/16Pj34PralqhFYk9wibc3+nUaqQE4aElGgU01q13NrmMB+oTswebNCosoJuUKnn7NLVQQ2hKQ781AZZ7Sq7CRdR7c0Cgi0ZV0bMwdfpLMpG8/O+g6tAgIHdF23OnWoVOnsBNpk1LbbBFarCSzrym5IDUDWdTwt+FGd/q70hoVUQWBJx5yrQtg+kE8Wy+NO5HqdDWHZSBrZjaYsW5L1SjdWUSJvstuMCXX65Q3J26MEdj/IuCJbE25r7LEmYVVmp4n9ft2acKWeQM9lYVW4bQzjTSZhuW4z+arwRj2BrktaVoQjM/d2k/qyNsmSjsujcHe/WvyXN2SvV56OymJ4+ABSd8Iqb1vc30WLqVNPYDF1ZL8unWDTgi+byGWTd1t+fhfWQgLQ8/OhlajOm+OuMKOAy+TbsiXrftOcQPZX2Uu1Ht+Zy4e+2NtFI1W+hJ51qvjlVjGB/vPgO3olwKYFWQV+d7iuyE4X4iwlAD0vyF6p9FLR6JSF06i8rrydL2j5x/gE9npTeFbWaTxJm8qL7BTpcEN41l27txCbqfrt9JfibuFXsqMMDNPsuVCmX9Reaf1FLZ9yKpUSqL5i+lp6Vfb1rVEo8lLRsNeF0GjbYof8FyerwNcTgGXfF87I8kThUka8uryq5ytOpz/UwasnsJg6woLsd7Ugy1eScSZyFn5i3fdqsRnnhuax+KiuU8J7G8dzVXwXl0O4KDzgx+nfTWA1v2b9Zvqj8Ijwl6GVZLpQGfY854WHmoJnkjuyR2Jey7eFe+w8tTGp16EnnNXxhHNp15a5Ko1/0f3d9IrwgOynspXa1aR+tVmSfcucR8cFzzS3lCfigDmfHYTVh0XBO9Wd/43I6Ai/xVPu9vzoYb1pmu6eeCFaXnOX8HnZSQZ3C1XA+79vCl+238884y0m/4Zidjf1D8ZR2ZP4uHAn9o2A/p/+kfCcjm84l5Zm0e1sv5U4EW0Hzeu5T/YxvF/o4mXZBXu94IxL03h8NM3+Yw/6oXXJ7TYckmW3Wva0G7MEvpn+DxZzjNuWWt/KAAAAAElFTkSuQmCC
// @homepageURL     https://github.com/vietthedev/hagezi-to-nextdns
// @supportURL      https://github.com/vietthedev/hagezi-to-nextdns/issues
// ==/UserScript==
(async t=>{const e=await import("https://esm.run/punycode"),n={en:{hidePanel:"Hide Panel",showPanel:"Show Panel",numberOfBlockedTlds:"Number of blocked TLDs",numberOfDeniedDomains:"Number of denied domains",numberOfAllowedDomains:"Number of allowed domains",importHageziTlds:"Import HaGeZi TLDs",removeHageziTlds:"Remove HaGeZi TLDs",importHageziTldsAggressive:"Import HaGeZi TLDs (Aggressive)",removeHageziTldsAggressive:"Remove HaGeZi TLDs (Aggressive)",importHageziTldAllowlist:"Import HaGeZi TLD allowlist",removeHageziTldAllowlist:"Remove HaGeZi TLD allowlist",importErrorTrackers:"Import error trackers",removeErrorTrackers:"Remove error trackers",importCustomList:"Import custom list",removeCustomList:"Remove custom list",adding:"Adding",removing:"Removing",done:"Done!",expand:"Expand",collapse:"Collapse",chooseAListToProceed:"Choose a list to proceed:\n1. Allowlist\n2. Denylist",areYouSureYouWantToProceed:"Are you sure you want to proceed?",allowlist:"Allowlist",denylist:"Denylist",enterTheLink:"Enter the link to the list in wildcard asterisk or wildcard domain format:"},vi:{hidePanel:"Ẩn Bảng",showPanel:"Hiện Bảng",numberOfBlockedTlds:"Số lượng TLD đã chặn",numberOfDeniedDomains:"Số lượng tên miền đã chặn",numberOfAllowedDomains:"Số lượng tên miền đã cho phép",importHageziTlds:"Nhập TLD HaGeZi",removeHageziTlds:"Xoá TLD HaGeZi",importHageziTldsAggressive:"Nhập TLD HaGeZi (phiên bản mạnh hơn)",removeHageziTldsAggressive:"Xoá TLD HaGeZi (phiên bản mạnh hơn)",importHageziTldAllowlist:"Nhập danh sách cho phép HaGeZi TLD",removeHageziTldAllowlist:"Xoá danh sách cho phép HaGeZi TLD",importErrorTrackers:"Nhập trình theo dõi lỗi",removeErrorTrackers:"Xoá trình theo dõi lỗi",importCustomList:"Nhập danh sách tuỳ chọn",removeCustomList:"Xoá danh sách tuỳ chọn",adding:"Đang thêm",removing:"Đang xoá",done:"Xong!",expand:"Mở rộng",collapse:"Thu gọn",chooseAListToProceed:"Chọn danh sách để tiến hành:\n1. Danh sách cho phép\n2. Danh sách chặn",areYouSureYouWantToProceed:"Bạn có chắc muốn tiến hành?",allowlist:"Danh sách cho phép",denylist:"Danh sách chặn",enterTheLink:'Nhập đường dẫn tới danh sách tên miền ở định dạng có hoặc không có dấu "*":'}}["vi"===t.navigator.language?"vi":"en"],i={Allowlist:"1",Denylist:"2"},o=(t=500)=>new Promise(e=>setTimeout(()=>e(),t)),a=t=>{let e="";for(let n=0;n<t.length;n++){e+=t.charCodeAt(n).toString(16).padStart(2,"0")}return e},s={getProfileId:()=>location.pathname.split("/")[1],profileIdExists:()=>location.pathname.split("/").length>=3,confirmProceed:()=>t.confirm(n.areYouSureYouWantToProceed),promptListType:()=>{let e;for(;null!==e&&!Object.values(i).includes(e);)e=t.prompt(n.chooseAListToProceed);return e},promptUrl:()=>{const e=/^(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/[a-zA-Z0-9]+\.[^\s]{2,}|[a-zA-Z0-9]+\.[^\s]{2,})$/;let i;for(;null!==i&&!e.test(i);)i=t.prompt(n.enterTheLink);return i},getAdblockList:async(t,e=!1)=>{const n=(await fetch(t).then(t=>t.text())).trim().matchAll(/^(\|\|)?(?<domain>(xn--)?[\w.-]+)(\^)?$/gm),i=new Set;for(const t of n)e&&t.groups.domain.includes(".")||i.add(t.groups.domain);return i},getWildcardList:async(t,e=!1)=>{const n=(await fetch(t).then(t=>t.text())).trim().matchAll(/^(\*\.)*(?<domain>[\w.-]+)$/gm),i=new Set;for(const t of n)e&&t.groups.domain.includes(".")||i.add(t.groups.domain);return i},getAbusedTlds:()=>s.getAdblockList("https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/spam-tlds-adblock.txt",!0),getAbusedTldsAggressive:()=>s.getWildcardList("https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/spam-tlds-onlydomains.txt",!0),getTldAllowlist:()=>s.getWildcardList("https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/spam-tlds-allow-onlydomains.txt"),getErrorTrackerList:()=>s.getWildcardList("https://cdn.jsdelivr.net/gh/vietthedev/hagezi-to-nextdns@latest/resources/error-trackers-onlydomains.txt")};class r{apiHost="https://api.nextdns.io";constructor(t){this.profileId=t}async request(t,e){const n=await fetch(`${this.apiHost}${t}`,{headers:{"Content-Type":"application/json",...e?.headers},mode:"cors",credentials:"include",...e});if(!n.ok)throw new Error(n.statusText);return n}async getSecurity(){const t=await this.request(`/profiles/${this.profileId}/security`);return await t.json()}async getDenylist(){const t=await this.request(`/profiles/${this.profileId}/denylist`);return await t.json()}async getAllowlist(){const t=await this.request(`/profiles/${this.profileId}/allowlist`);return await t.json()}addTld(t){return this.request(`/profiles/${this.profileId}/security/tlds`,{method:"POST",body:JSON.stringify({id:t})})}removeTld(t){return this.request(`/profiles/${this.profileId}/security/tlds/hex:${a(t)}`,{method:"DELETE"})}denylistDomain(t){return this.request(`/profiles/${this.profileId}/denylist`,{method:"POST",body:JSON.stringify({active:!0,id:t})})}allowlistDomain(t){return this.request(`/profiles/${this.profileId}/allowlist`,{method:"POST",body:JSON.stringify({active:!0,id:t})})}removeDeniedDomain(t){return this.request(`/profiles/${this.profileId}/denylist/hex:${a(t)}`,{method:"DELETE"})}removeAllowedDomain(t){return this.request(`/profiles/${this.profileId}/allowlist/hex:${a(t)}`,{method:"DELETE"})}}const d='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/></svg>',l=()=>{const t=document.querySelector(".panel-container"),e=document.querySelector(".toggle-button");requestAnimationFrame(function i(){const{opacity:o}=getComputedStyle(t);if("0"===o)return t.classList.add("hidden"),void(e&&(e.textContent=n.showPanel));t.style.opacity=Number.parseFloat(o)-.1,requestAnimationFrame(i)})},c=()=>{const t=document.querySelector(".panel-container"),e=document.querySelector(".toggle-button");t.classList.remove("hidden"),requestAnimationFrame(function i(){const{opacity:o}=getComputedStyle(t);"1"!==o?(t.style.opacity=Number.parseFloat(o)+.1,requestAnimationFrame(i)):e&&(e.textContent=n.hidePanel)})},{cardBody:m,loader:p,progress:u,statList:g,expandButton:h,controlContainer:w,toggleButtonContainer:b,importHageziTldsButton:f,removeHageziTldsButton:v,importHageziTldsAggressiveButton:y,removeHageziTldsAggressiveButton:T,importHageziTldAllowlistButton:L,removeHageziTldAllowlistButton:x,importErrorTrackersButton:C,removeErrorTrackersButton:A,importCustomListButton:$,removeCustomListButton:E}=(()=>{const t=document.createElement("button"),e=document.createElement("div"),i=document.createElement("button"),o=document.createElement("div"),a=document.createElement("div"),s=document.createElement("div"),r=document.createElement("div"),m=document.createElement("ul"),p=document.createElement("div"),u=document.createElement("button"),g=document.createElement("button"),h=document.createElement("button"),w=document.createElement("button"),b=document.createElement("button"),f=document.createElement("button"),v=document.createElement("button"),y=document.createElement("button"),T=document.createElement("button"),L=document.createElement("button"),x=document.createElement("p"),C=document.createElement("div");return C.classList.add("text-center"),C.innerHTML='<div class="loader" />',m.classList.add("stat-list"),i.classList.add("btn","panel-expand-button"),i.type="button",i.innerHTML=d,i.title=n.expand,p.classList.add("panel-control-container","hidden"),u.classList.add("btn","btn-primary","btn-sm"),g.classList.add("btn","btn-danger","btn-sm"),h.classList.add("btn","btn-primary","btn-sm"),w.classList.add("btn","btn-danger","btn-sm"),b.classList.add("btn","btn-primary","btn-sm"),f.classList.add("btn","btn-danger","btn-sm"),v.classList.add("btn","btn-primary","btn-sm"),y.classList.add("btn","btn-danger","btn-sm"),T.classList.add("btn","btn-primary","btn-sm"),L.classList.add("btn","btn-danger","btn-sm"),u.type="button",g.type="button",h.type="button",w.type="button",b.type="button",f.type="button",v.type="button",y.type="button",T.type="button",L.type="button",u.textContent=n.importHageziTlds,g.textContent=n.removeHageziTlds,h.textContent=n.importHageziTldsAggressive,w.textContent=n.removeHageziTldsAggressive,b.textContent=n.importHageziTldAllowlist,f.textContent=n.removeHageziTldAllowlist,v.textContent=n.importErrorTrackers,y.textContent=n.removeErrorTrackers,T.textContent=n.importCustomList,L.textContent=n.removeCustomList,p.appendChild(u),p.appendChild(g),p.appendChild(h),p.appendChild(w),p.appendChild(b),p.appendChild(f),p.appendChild(v),p.appendChild(y),p.appendChild(T),p.appendChild(L),x.classList.add("panel-progress"),o.classList.add("card","panel-container","hidden"),o.style.opacity="0",a.classList.add("card-header"),a.innerHTML='<h6 class="mb-0 text-center">HaGeZi to NextDNS</h6>',s.classList.add("card-body"),s.appendChild(C),s.appendChild(m),s.appendChild(x),r.classList.add("card-footer","panel-footer"),r.appendChild(i),r.appendChild(p),e.classList.add("nav-item","d-flex","align-items-center","toggle-button-container"),t.classList.add("btn","btn-primary","toggle-button"),t.textContent=t.classList.contains("hidden")?n.showPanel:n.hidePanel,t.type="button",t.addEventListener("click",()=>{document.querySelector(".panel-container").classList.contains("hidden")?c():l()}),o.appendChild(a),o.appendChild(s),o.appendChild(r),e.appendChild(t),document.body.appendChild(o),{card:o,cardBody:s,cardFooter:r,loader:C,progress:x,statList:m,expandButton:i,controlContainer:p,toggleButtonContainer:e,importHageziTldsButton:u,removeHageziTldsButton:g,importHageziTldsAggressiveButton:h,removeHageziTldsAggressiveButton:w,importHageziTldAllowlistButton:b,removeHageziTldAllowlistButton:f,importErrorTrackersButton:v,removeErrorTrackersButton:y,importCustomListButton:T,removeCustomListButton:L}})(),D=()=>{new MutationObserver(()=>{const t=document.querySelector(".nav");t?.querySelector(".toggle-button")||t.appendChild(b)}).observe(document.body,{childList:!0,subtree:!0})},H=t=>{if(t)return f.disabled=!0,v.disabled=!0,y.disabled=!0,T.disabled=!0,L.disabled=!0,x.disabled=!0,C.disabled=!0,A.disabled=!0,$.disabled=!0,void(E.disabled=!0);f.disabled=!1,v.disabled=!1,y.disabled=!1,T.disabled=!1,L.disabled=!1,x.disabled=!1,C.disabled=!1,A.disabled=!1,$.disabled=!1,E.disabled=!1},P=async()=>{const t=s.getProfileId(),i=new r(t);H(!0);const[o,a,d]=await Promise.all([i.getSecurity().then(t=>t.data.tlds.map(({id:t})=>t.startsWith("xn--")?e.toUnicode(t):t)),i.getDenylist().then(t=>t.data.map(({id:t})=>t)),i.getAllowlist().then(t=>t.data.map(({id:t})=>t))]),l=new Blob([o.toSorted().join("\n")],{type:"text/plain;charset=utf-8"}),c=new Blob([a.toSorted().join("\n")],{type:"text/plain"}),m=new Blob([d.toSorted().join("\n")],{type:"text/plain"});H(!1),g.innerHTML=`\n    <li>${n.numberOfBlockedTlds}: <a href="${URL.createObjectURL(l)}" target="_blank">${o.length}</a></li>\n    <li>${n.numberOfDeniedDomains}: <a href="${URL.createObjectURL(c)}" target="_blank">${a.length}</a></li>\n    <li>${n.numberOfAllowedDomains}: <a href="${URL.createObjectURL(m)}" target="_blank">${d.length}</a></li>\n    `};D(),h.addEventListener("click",t=>{const e=t.currentTarget;if(w.classList.contains("hidden"))return w.classList.remove("hidden"),e.title=n.collapse,void(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M480-528 296-344l-56-56 240-240 240 240-56 56-184-184Z"/></svg>');w.classList.add("hidden"),e.title=n.expand,e.innerHTML=d}),f.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getSecurity().then(t=>t.data.tlds.map(({id:t})=>t)),s.getAbusedTlds()]),a=i.difference(new Set(t));let r=1;for(const t of a)u.textContent=`${n.adding} ${t} (${r}/${a.size})`,await e.addTld(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),v.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getSecurity().then(t=>t.data.tlds.map(({id:t})=>t)),s.getAbusedTlds()]),a=i.intersection(new Set(t));let r=1;for(const t of a)u.textContent=`${n.removing} ${t} (${r}/${a.size})`,await e.removeTld(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),y.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getSecurity().then(t=>t.data.tlds.map(({id:t})=>t)),s.getAbusedTldsAggressive()]),a=i.difference(new Set(t));let r=1;for(const t of a)u.textContent=`${n.adding} ${t} (${r}/${a.size})`,await e.addTld(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),T.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getSecurity().then(t=>t.data.tlds.map(({id:t})=>t)),s.getAbusedTldsAggressive()]),a=i.intersection(new Set(t));let r=1;for(const t of a)u.textContent=`${n.removing} ${t} (${r}/${a.size})`,await e.removeTld(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),L.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getAllowlist().then(t=>t.data.map(({id:t})=>t)),s.getTldAllowlist()]),a=i.difference(new Set(t));let r=1;for(const t of a)u.textContent=`${n.adding} ${t} (${r}/${a.size})`,await e.allowlistDomain(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),x.addEventListener("click",async()=>{if(!s.confirmProceed())return;H(!0);const t=s.getProfileId(),e=new r(t);try{const[t,i]=await Promise.all([e.getAllowlist().then(t=>t.data.map(({id:t})=>t)),s.getTldAllowlist()]),a=i.intersection(new Set(t));let r=1;for(const t of a)u.textContent=`${n.removing} ${t} (${r}/${a.size})`,await e.removeAllowedDomain(t),await o(),r++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),C.addEventListener("click",async()=>{const t=s.promptListType();if(!t)return;if(!s.confirmProceed())return;H(!0);const e=s.getProfileId(),a=new r(e);try{const[e,r]=await Promise.all([t===i.Allowlist?a.getAllowlist().then(t=>t.data.map(({id:t})=>t)):a.getDenylist().then(t=>t.data.map(({id:t})=>t)),s.getErrorTrackerList()]),d=r.difference(new Set(e)),l=t===i.Allowlist?a.allowlistDomain.bind(a):a.denylistDomain.bind(a);let c=1;for(const t of d)u.textContent=`${n.adding} ${t} (${c}/${d.size})`,await l(t),await o(),c++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),A.addEventListener("click",async()=>{const t=s.promptListType();if(!t)return;if(!s.confirmProceed())return;H(!0);const e=s.getProfileId(),a=new r(e);try{const[e,r]=await Promise.all([t===i.Allowlist?a.getAllowlist().then(t=>t.data.map(({id:t})=>t)):a.getDenylist().then(t=>t.data.map(({id:t})=>t)),s.getErrorTrackerList()]),d=r.intersection(new Set(e)),l=t===i.Allowlist?a.removeAllowedDomain.bind(a):a.removeDeniedDomain.bind(a);let c=1;for(const t of d)u.textContent=`${n.removing} ${t} (${c}/${d.size})`,await l(t),await o(),c++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),$.addEventListener("click",async()=>{const t=s.promptUrl();if(!t)return;const e=s.promptListType();if(!e)return;if(!s.confirmProceed())return;H(!0);const a=s.getProfileId(),d=new r(a);try{const[a,r]=await Promise.all([e===i.Allowlist?d.getAllowlist().then(t=>t.data.map(({id:t})=>t)):d.getDenylist().then(t=>t.data.map(({id:t})=>t)),s.getWildcardList(t)]),l=r.difference(new Set(a)),c=e===i.Allowlist?d.allowlistDomain.bind(d):d.denylistDomain.bind(d);let m=1;for(const t of l)u.textContent=`${n.adding} ${t} (${m}/${l.size})`,await c(t),await o(),m++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)}),E.addEventListener("click",async()=>{const t=s.promptUrl();if(!t)return;const e=s.promptListType();if(!e)return;if(!s.confirmProceed())return;H(!0);const a=s.getProfileId(),d=new r(a);try{const[a,r]=await Promise.all([e===i.Allowlist?d.getAllowlist().then(t=>t.data.map(({id:t})=>t)):d.getDenylist().then(t=>t.data.map(({id:t})=>t)),s.getWildcardList(t)]),l=r.intersection(new Set(a)),c=e===i.Allowlist?d.removeAllowedDomain.bind(d):d.removeDeniedDomain.bind(d);let m=1;for(const t of l)u.textContent=`${n.removing} ${t} (${m}/${l.size})`,await c(t),await o(),m++}catch(t){return void(u.textContent=t.message)}await P(),u.textContent=n.done,H(!1)});let z=!1;const k=async()=>{s.profileIdExists()?(c(),D(),z||(g.innerHTML="",m.prepend(p),await P(),p.remove(),z=!0)):l()};t.navigation?.addEventListener("navigatesuccess",k),k(),GM_addStyle("\n    .panel-container {\n      position: fixed;\n      right: 1rem;\n      bottom: 1rem;\n    }\n\n    .toggle-button-container {\n      justify-content: end;\n      flex: 1;\n    }\n\n    .toggle-button {\n      white-space: nowrap;\n    }\n\n    .stat-list {\n      list-style: initial;\n    }\n\n    .panel-progress {\n      margin: 0;\n    }\n\n    .panel-footer {\n      display: flex;\n      flex-direction: column;\n      row-gap: .5rem;\n    }\n\n    .panel-control-container {\n      display: flex;\n      flex-direction: column;\n      row-gap: .5rem;\n    }\n\n    .panel-control-container > .btn {\n      width: fit-content;\n    }\n\n    .panel-footer > .panel-expand-button {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      width: auto;\n      padding: 0;\n    }\n\n    .hidden {\n      display: none;\n    }\n\n    .loader {\n      width: 1.5rem;\n      height: 1.5rem;\n      border: 2px solid #000;\n      border-bottom-color: transparent;\n      border-radius: 50%;\n      display: inline-block;\n      box-sizing: border-box;\n      animation: rotation 1s linear infinite;\n    }\n\n    @keyframes rotation {\n      0% {\n        transform: rotate(0deg);\n      }\n\n      100% {\n        transform: rotate(360deg);\n      }\n    }\n  ")})(window);